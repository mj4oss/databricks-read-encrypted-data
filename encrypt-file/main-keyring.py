import base64
import aws_encryption_sdk
from aws_encryption_sdk.identifiers import CommitmentPolicy

def decrypt_node_data(base64_ciphertext, kms_key_arn):
    # 1. Decode the base64 string to raw bytes
    ciphertext_bytes = base64.b64decode(base64_ciphertext)

    # 2. Set up the Master Key Provider
    # Note: Ensure your IAM role has kms:Decrypt permissions on the key
    kms_kwargs = dict(key_ids=[kms_key_arn])
    master_key_provider = aws_encryption_sdk.StrictAwsKmsMasterKeyProvider(**kms_kwargs)

    # 3. Decrypt
    # Use REQUIRE_ENCRYPT_REQUIRE_DECRYPT if using the latest SDK versions
    client = aws_encryption_sdk.EncryptionSDKClient(
        commitment_policy=CommitmentPolicy.REQUIRE_ENCRYPT_REQUIRE_DECRYPT
    )
    
    decrypted_plaintext, header = client.decrypt(
        source=ciphertext_bytes,
        key_provider=master_key_provider
    )

    return decrypted_plaintext.decode('utf-8')

# encrypted_data_from_s3 = "AgV4f4O8I2vNEFXN2mXsLhMs/rJsfZDBGLm4jSTjNqV8IWoAXwABABVhd3MtY3J5cHRvLXB1YmxpYy1rZXkAREE1dWRjS2Q4Vm80a0I3d0YwVlZhZXF3NHhNaGJzK21sRWZGWGpnR3ByektCVnF5aFh1clJtRFdDMnFlcXhJaURzUT09AAEAB2F3cy1rbXMAS2Fybjphd3M6a21zOnVzLXdlc3QtMjo5NTk3OTA2NjAzMDE6a2V5LzJlMGZiYzkxLTI1ZWEtNGEzNy1iNWY1LWZmOGM3MzcwMGM1MwC4AQIBAHhfSF+uh84PvV+rAmbJk8WGDUh/7cKgNNrfb1b+HTi7mAEPvo9l5/GIfUbL00+p9aGxAAAAfjB8BgkqhkiG9w0BBwagbzBtAgEAMGgGCSqGSIb3DQEHATAeBglghkgBZQMEAS4wEQQMnWncDsJkiqDnXu8mAgEQgDuDCi+LtUdphPM2gMIscz7O+DQAP8VhIYTlGYTMYrP2IzllfFV2OeTSnZYWE7UYQigrFKy/0CS1i5t9GgIAABAAopXvLnGDps3ccuikH1jihJEfSmdam4Miflc+UV9XJKX6AKLjhsxEY82Bx1xruk8p/////wAAAAEAAAAAAAAAAAAAAAEAAAARJjgs8dF7V395vvSFSrtCGfACN0i3wlJemrrjFk1JRty5AGYwZAIwSgJKFEJwZAAwVR3ba4GGwJnIIRn1ngOeyWcTI+Wc4fiqJFhdU48BfTH2DJ+wfDzfAjBSSLUb+AcyfSZkVrvQJiQNfkVqmjWLXy6eGVLM7Aypq7mrfcfIWtf04CWCgnAgd+0=" 


encrypted_data_from_s3 = "AgV4PeYUS0qWmGp8ECv4CBFKmVlxw1Nz5yH8Hw3vpzMKf14AXwABABVhd3MtY3J5cHRvLXB1YmxpYy1rZXkAREF3eXZjVFFHWUUvK0R2bWR3YUttTVRRaTRRZnIrMGFYK2tVNjhUbkRtL0tUZGZPS2VOQi80aUlzNnI1QzU3cjdyUT09AAEAB2F3cy1rbXMAS2Fybjphd3M6a21zOnVzLXdlc3QtMjo5NTk3OTA2NjAzMDE6a2V5LzJlMGZiYzkxLTI1ZWEtNGEzNy1iNWY1LWZmOGM3MzcwMGM1MwC4AQIBAHhfSF+uh84PvV+rAmbJk8WGDUh/7cKgNNrfb1b+HTi7mAEYxWodDVTB1gcveiKo9ZkQAAAAfjB8BgkqhkiG9w0BBwagbzBtAgEAMGgGCSqGSIb3DQEHATAeBglghkgBZQMEAS4wEQQMyGL6BiLGN9XulYP9AgEQgDuRhTq5DhJUqHCHn83G73nYe93MP9Hk6eySu5mHjRpoECo9NoUQHUlPT3oG4VHarpIQp57JtvVo4T1h0gIAABAAozp+Z+72uF3e3j73+LaXIYFhqfLM57OjeoDsWtDFLe7vi3yzvP/Scxt7Foc40u2C/////wAAAAEAAAAAAAAAAAAAAAEAAAMBA6V/vboMhUJ3Uzvp/kiODMkuz1JCEEM6cnNKEwcxb5qZ/Wa7N/yCFQe3cP8jcyZ48HJmXhuccQt9Y7O+hYtq4aT2PuMKezWKlFpgvgZBKJ/NfTtY/ZMSJYDzit3BgSI2akGsM1CSsOBI/nQooTTB4vLgmECyfgmGP8VJBnS2TFQo9oJ1G5GD2glpU48uqHP6DWHnpScXKtJfiufUmfizvhhPEifE3klkV0e1V/BZwkPvyYtAqfQv7A1ZjJjXu2wtcnD99t4PgypAbZJPk+MCrLOUtConfaTnBugaEriQ22PK5/Tft2G6kUH1QxJ8J6oax6dRotih4du+apDbTOB36HiSecqB2CnPuoL9oVDD49tG0BJpnxFFcifmNRKtQPmdo+gowUtGu3w+/fcFHnH5ox+wRI38xw24AP3FpT98LE9P3MckJif1A6D0KdWti+VfGqgcm3f3yVIeHBdTF1bJYChgDid6d9BTg5X65IY2uOwQXCUPB4c3w3DhVzEoXav6IsSzaNzhG4f9iQCKG7UhtAAyQFGWfMIsNlQuJBzu8EBA1rK3XcElB7KelUfMXdYhCTJgeuyBDLOiNMYtbSszc3JinPBbMiqs+mbcTx8atBHmI1otd9YIN+k81Xd2MKYGIyvpGIahRJQtBOcXLamuqptkamWWVW6R5zsb/Xa2Y2b4WlB35lbpa6Tv8Ctzsxv2YwU4QvvhGF83iP+EcUXvKvdNTRO+EWSTinOTuupGcCsQATZcbb3b+GoEpfMMoW1R1syCX7se7fcQ5ZabT64EZyaWy6tyxGyFzDvOWKQk2hRSi9+RbDrUZ/zMqkP55TpPNnAoee7hpLiE5OZXuVIcME7aAHMa0zY+0CUS/vUl9+haFB9kIiVCTkoqqKXezxCta+iBFcrbx16XqqqKtK3lXW4AatwW4EGRqwRaXRgF0v0iLWSpE4pyZ8ds175y0z1D0WZEHxDZRdTiw2gWdR8/ONxgI9vUz0upE8WC69wzKN220RpKfHyIT3HuaBP66nCfjKzaGymMSUVPTCrsAmREKT0AZzBlAjBUrODn2XoyA6RNrAE5VQMLgx0Okg9PUlK/4G75jcI3helqd2DZ6YY7gYBngPLvXzgCMQDAcuOCS0g1LEjqNBl362G8rO2KVI5jYyVEcqbH/jlAZQrC1thNrgA6GSeBIraD5Rg="
key_arn = "arn:aws:kms:us-west-2:959790660301:key/2e0fbc91-25ea-4a37-b5f5-ff8c73700c53"
print(decrypt_node_data(encrypted_data_from_s3, key_arn))